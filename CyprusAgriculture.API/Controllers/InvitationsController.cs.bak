using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using CyprusAgriculture.API.Data;
using CyprusAgriculture.API.Models;
using System.Text.Json;

namespace CyprusAgriculture.API.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class InvitationsController : ControllerBase
    {
        private readonly CyprusAgricultureDbContext _context;
        private readonly ILogger<InvitationsController> _logger;

        public InvitationsController(CyprusAgricultureDbContext context, ILogger<InvitationsController> logger)
        {
            _context = context;
            _logger = logger;
        }

        // GET: api/invitations
        [HttpGet]
        public async Task<ActionResult<IEnumerable<object>>> GetInvitations(
            [FromQuery] string? status = null,
            [FromQuery] Guid? sampleId = null,
            [FromQuery] int page = 1,
            [FromQuery] int pageSize = 10)
        {
            try
            {
                var query = _context.Invitations
                    .Include(i => i.Sample)
                    .Include(i => i.Questionnaire)
                    .Include(i => i.Creator)
                    .AsQueryable();

                if (!string.IsNullOrEmpty(status))
                {
                    query = query.Where(i => i.Status == status);
                }

                if (sampleId.HasValue)
                {
                    query = query.Where(i => i.SampleId == sampleId.Value);
                }

                var totalCount = await query.CountAsync();
                var invitations = await query
                    .OrderByDescending(i => i.CreatedAt)
                    .Skip((page - 1) * pageSize)
                    .Take(pageSize)
                    .Select(i => new
                    {
                        i.Id,
                        i.Name,
                        i.Subject,
                        i.Status,
                        i.DeliveryStatus,
                        i.ParticipationStatus,
                        SampleName = i.Sample.Name,
                        QuestionnaireName = i.Questionnaire.Name,
                        CreatedBy = i.Creator.FirstName + " " + i.Creator.LastName,
                        i.ScheduledAt,
                        i.SentAt,
                        i.CreatedAt
                    })
                    .ToListAsync();

                return Ok(new
                {
                    data = invitations,
                    totalCount,
                    page,
                    pageSize,
                    totalPages = (int)Math.Ceiling((double)totalCount / pageSize)
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error retrieving invitations");
                return StatusCode(500, new { error = "Internal server error", details = ex.Message });
            }
        }

        // GET: api/invitations/{id}
        [HttpGet("{id}")]
        public async Task<ActionResult<object>> GetInvitation(Guid id)
        {
            try
            {
                var invitation = await _context.Invitations
                    .Include(i => i.Sample)
                    .Include(i => i.Questionnaire)
                    .Include(i => i.Participant)
                    .Include(i => i.Creator)
                    .FirstOrDefaultAsync(i => i.Id == id);

                if (invitation == null)
                {
                    return NotFound(new { error = "Invitation not found" });
                }

                return Ok(new
                {
                    invitation.Id,
                    invitation.Name,
                    invitation.Description,
                    invitation.Subject,
                    invitation.HtmlContent,
                    invitation.PlainTextContent,
                    invitation.LogoUrl,
                    invitation.LogoAlignment,
                    StyleSettings = JsonSerializer.Deserialize<object>(invitation.StyleSettings),
                    invitation.Status,
                    invitation.DeliveryStatus,
                    invitation.ParticipationStatus,
                    invitation.ScheduledAt,
                    invitation.SendImmediately,
                    Sample = new
                    {
                        invitation.Sample.Id,
                        invitation.Sample.Name,
                        invitation.Sample.CurrentSize
                    },
                    Questionnaire = new
                    {
                        invitation.Questionnaire.Id,
                        invitation.Questionnaire.Name
                    },
                    Participant = invitation.Participant != null ? new
                    {
                        invitation.Participant.Id,
                        invitation.Participant.FarmName,
                        invitation.Participant.OwnerName,
                        invitation.Participant.Email
                    } : null,
                    CreatedBy = invitation.Creator.FirstName + " " + invitation.Creator.LastName,
                    invitation.CreatedAt,
                    invitation.SentAt,
                    invitation.DeliveredAt,
                    invitation.StartedAt,
                    invitation.CompletedAt
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error retrieving invitation {Id}", id);
                return StatusCode(500, new { error = "Internal server error", details = ex.Message });
            }
        }

        // POST: api/invitations
        [HttpPost]
        public async Task<ActionResult<object>> CreateInvitation([FromBody] CreateInvitationRequest request)
        {
            try
            {
                // Validate sample exists
                var sample = await _context.Samples
                    .Include(s => s.Questionnaire)
                    .FirstOrDefaultAsync(s => s.Id == request.SampleId);
                
                if (sample == null)
                {
                    return BadRequest(new { error = "Sample not found" });
                }

                var invitation = new Invitation
                {
                    Name = request.Name,
                    Description = request.Description,
                    SampleId = request.SampleId,
                    QuestionnaireId = sample.QuestionnaireId,
                    Subject = request.Subject,
                    HtmlContent = request.HtmlContent,
                    PlainTextContent = request.PlainTextContent,
                    LogoUrl = request.LogoUrl,
                    LogoAlignment = request.LogoAlignment ?? "center",
                    StyleSettings = JsonSerializer.Serialize(request.StyleSettings ?? new object()),
                    ScheduledAt = request.ScheduledAt,
                    SendImmediately = request.SendImmediately,
                    CreatedBy = request.CreatedBy,
                    Status = "draft"
                };

                _context.Invitations.Add(invitation);
                await _context.SaveChangesAsync();

                _logger.LogInformation("Invitation created: {Id}", invitation.Id);

                return CreatedAtAction(nameof(GetInvitation), new { id = invitation.Id }, new
                {
                    invitation.Id,
                    invitation.Name,
                    invitation.Status,
                    invitation.CreatedAt,
                    message = "Invitation created successfully"
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating invitation");
                return StatusCode(500, new { error = "Internal server error", details = ex.Message });
            }
        }

        // PUT: api/invitations/{id}
        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateInvitation(Guid id, [FromBody] UpdateInvitationRequest request)
        {
            try
            {
                var invitation = await _context.Invitations.FindAsync(id);
                if (invitation == null)
                {
                    return NotFound(new { error = "Invitation not found" });
                }

                invitation.Name = request.Name ?? invitation.Name;
                invitation.Description = request.Description ?? invitation.Description;
                invitation.Subject = request.Subject ?? invitation.Subject;
                invitation.HtmlContent = request.HtmlContent ?? invitation.HtmlContent;
                invitation.PlainTextContent = request.PlainTextContent ?? invitation.PlainTextContent;
                invitation.LogoUrl = request.LogoUrl ?? invitation.LogoUrl;
                invitation.LogoAlignment = request.LogoAlignment ?? invitation.LogoAlignment;
                
                if (request.StyleSettings != null)
                {
                    invitation.StyleSettings = JsonSerializer.Serialize(request.StyleSettings);
                }

                invitation.ScheduledAt = request.ScheduledAt ?? invitation.ScheduledAt;
                invitation.SendImmediately = request.SendImmediately ?? invitation.SendImmediately;
                invitation.UpdatedAt = DateTime.UtcNow;

                await _context.SaveChangesAsync();

                _logger.LogInformation("Invitation updated: {Id}", id);

                return Ok(new { message = "Invitation updated successfully" });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating invitation {Id}", id);
                return StatusCode(500, new { error = "Internal server error", details = ex.Message });
            }
        }

        // POST: api/invitations/{id}/send
        [HttpPost("{id}/send")]
        public async Task<ActionResult<object>> SendInvitation(Guid id)
        {
            try
            {
                var invitation = await _context.Invitations
                    .Include(i => i.Sample)
                    .ThenInclude(s => s.Participants)
                    .FirstOrDefaultAsync(i => i.Id == id);

                if (invitation == null)
                {
                    return NotFound(new { error = "Invitation not found" });
                }

                // Για το demo, θα προσομοιώσουμε την αποστολή
                var participants = invitation.Sample.Participants.Where(p => p.Status == "active").ToList();
                int successCount = 0;
                int failureCount = 0;

                foreach (var participant in participants)
                {
                    // Προσομοίωση αποστολής email - 90% επιτυχία
                    var random = new Random();
                    if (random.NextDouble() < 0.9)
                    {
                        successCount++;
                        // Δημιουργία ατομικής πρόσκλησης για κάθε συμμετέχοντα
                        var participantInvitation = new Invitation
                        {
                            Name = $"{invitation.Name} - {participant.OwnerName}",
                            SampleId = invitation.SampleId,
                            QuestionnaireId = invitation.QuestionnaireId,
                            ParticipantId = participant.Id,
                            Subject = invitation.Subject,
                            HtmlContent = invitation.HtmlContent,
                            PlainTextContent = invitation.PlainTextContent,
                            LogoUrl = invitation.LogoUrl,
                            LogoAlignment = invitation.LogoAlignment,
                            StyleSettings = invitation.StyleSettings,
                            CreatedBy = invitation.CreatedBy,
                            Status = "sent",
                            DeliveryStatus = "delivered",
                            SentAt = DateTime.UtcNow,
                            DeliveredAt = DateTime.UtcNow
                        };
                        _context.Invitations.Add(participantInvitation);
                    }
                    else
                    {
                        failureCount++;
                    }
                }

                // Ενημέρωση της κύριας πρόσκλησης
                invitation.Status = "sent";
                invitation.SentAt = DateTime.UtcNow;
                invitation.UpdatedAt = DateTime.UtcNow;

                await _context.SaveChangesAsync();

                _logger.LogInformation("Invitation sent: {Id}, Success: {Success}, Failures: {Failures}", 
                    id, successCount, failureCount);

                return Ok(new
                {
                    message = "Invitation sent successfully",
                    totalParticipants = participants.Count,
                    successfulDeliveries = successCount,
                    failedDeliveries = failureCount,
                    deliveryRate = participants.Count > 0 ? (double)successCount / participants.Count * 100 : 0
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error sending invitation {Id}", id);
                return StatusCode(500, new { error = "Internal server error", details = ex.Message });
            }
        }

        // GET: api/invitations/{id}/stats
        [HttpGet("{id}/stats")]
        public async Task<ActionResult<object>> GetInvitationStats(Guid id)
        {
            try
            {
                var invitation = await _context.Invitations
                    .Include(i => i.Sample)
                    .FirstOrDefaultAsync(i => i.Id == id);

                if (invitation == null)
                {
                    return NotFound(new { error = "Invitation not found" });
                }

                // Στατιστικά από τις ατομικές προσκλήσεις
                var individualInvitations = await _context.Invitations
                    .Where(i => i.SampleId == invitation.SampleId && i.ParticipantId != null)
                    .ToListAsync();

                var totalSent = individualInvitations.Count;
                var delivered = individualInvitations.Count(i => i.DeliveryStatus == "delivered");
                var failed = individualInvitations.Count(i => i.DeliveryStatus == "failed");
                var started = individualInvitations.Count(i => i.ParticipationStatus == "started");
                var completed = individualInvitations.Count(i => i.ParticipationStatus == "completed");

                return Ok(new
                {
                    invitationId = id,
                    sampleSize = invitation.Sample.CurrentSize,
                    emailStats = new
                    {
                        totalSent,
                        delivered,
                        failed,
                        deliveryRate = totalSent > 0 ? (double)delivered / totalSent * 100 : 0
                    },
                    participationStats = new
                    {
                        notStarted = totalSent - started - completed,
                        started,
                        completed,
                        participationRate = totalSent > 0 ? (double)(started + completed) / totalSent * 100 : 0,
                        completionRate = totalSent > 0 ? (double)completed / totalSent * 100 : 0
                    },
                    timeline = individualInvitations
                        .Where(i => i.SentAt.HasValue)
                        .GroupBy(i => i.SentAt.Value.Date)
                        .Select(g => new
                        {
                            date = g.Key,
                            sent = g.Count(),
                            delivered = g.Count(i => i.DeliveryStatus == "delivered"),
                            started = g.Count(i => i.ParticipationStatus == "started"),
                            completed = g.Count(i => i.ParticipationStatus == "completed")
                        })
                        .OrderBy(t => t.date)
                        .ToList()
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error retrieving invitation stats {Id}", id);
                return StatusCode(500, new { error = "Internal server error", details = ex.Message });
            }
        }

        // DELETE: api/invitations/{id}
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteInvitation(Guid id)
        {
            try
            {
                var invitation = await _context.Invitations.FindAsync(id);
                if (invitation == null)
                {
                    return NotFound(new { error = "Invitation not found" });
                }

                _context.Invitations.Remove(invitation);
                await _context.SaveChangesAsync();

                _logger.LogInformation("Invitation deleted: {Id}", id);

                return Ok(new { message = "Invitation deleted successfully" });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting invitation {Id}", id);
                return StatusCode(500, new { error = "Internal server error", details = ex.Message });
            }
        }
    }

    // DTOs
    public class CreateInvitationRequest
    {
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public Guid SampleId { get; set; }
        public string Subject { get; set; } = string.Empty;
        public string HtmlContent { get; set; } = string.Empty;
        public string? PlainTextContent { get; set; }
        public string? LogoUrl { get; set; }
        public string? LogoAlignment { get; set; }
        public object? StyleSettings { get; set; }
        public DateTime? ScheduledAt { get; set; }
        public bool SendImmediately { get; set; } = false;
        public Guid CreatedBy { get; set; }
    }

    public class UpdateInvitationRequest
    {
        public string? Name { get; set; }
        public string? Description { get; set; }
        public string? Subject { get; set; }
        public string? HtmlContent { get; set; }
        public string? PlainTextContent { get; set; }
        public string? LogoUrl { get; set; }
        public string? LogoAlignment { get; set; }
        public object? StyleSettings { get; set; }
        public DateTime? ScheduledAt { get; set; }
        public bool? SendImmediately { get; set; }
    }
}